<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	template="/template.xhtml">

	<f:metadata>
		<f:viewParam name="articleId"
			value="#{viewArticleManagedBean.articleId}" />
		<f:viewParam name="highlightCommentId"
			value="#{viewArticleManagedBean.highlightCommentId}" />
		<f:viewAction action="#{viewArticleManagedBean.loadArticle()}" />
	</f:metadata>

	<ui:define name="content">

		<h:messages showSummary="true" />
		<h:panelGroup rendered="#{viewArticleManagedBean.article!=null}">
			<h:panelGroup id="viewedarticlepreview">
				<ui:include src="articlepreview.xhtml">
					<ui:param name="article" value="#{viewArticleManagedBean.article}" />

				</ui:include>
			</h:panelGroup>
			<h:form id="articlelinkform">
				<h:outputLink value="#{viewArticleManagedBean.article.url}">#{yescommentmsg['open_original_article']}</h:outputLink>

			</h:form>
			<hr />
			<h:form id="newcommentform">
				New Comment
				<h:inputTextarea value="#{viewArticleManagedBean.newCommentText}"
					pt:maxlength="#{viewArticleManagedBean.getMaxCommentSize()}"
					id="newCommentText" rows="5" cols="80" required="true"
					requiredMessage="Empty comment" />
				<h:message for="newCommentText" showSummary="true" showDetail="false"
						errorClass="errorstyle" />
				<br />
				<h:outputText value="#{yescommentmsg['name']}" />
				<h:inputText id="name" value="#{userSessionBean.userName}"
					maxlength="#{userSessionBean.getMaxAuthorSize()}">
					<f:ajax />
				</h:inputText>
				<h:commandButton value="Post Comment" styleClass="button" id="postcommentbutton"
					disabled="#{!captchaManagedBean.captchaCorrectlyAnswered}"
					actionListener="#{viewArticleManagedBean.postNewComment()}">
					<f:ajax render=":comments @form :viewedarticlepreview"
						execute="@form" />
				</h:commandButton>

			</h:form>
			<h:form id="captchaform">
				<h:panelGroup
					rendered="#{captchaManagedBean.captchaCorrectlyAnswered}">
					<h:outputText value="Capcha already answered" />
				</h:panelGroup>
				<h:panelGroup
					rendered="#{!captchaManagedBean.captchaCorrectlyAnswered}">
					<h:outputText
						value="In order to post comment, you should answer a capthca." />

					<h:outputText value="Please enter username and select:" />
					<h:outputText
						value="#{captchaManagedBean.localizeColor(captchaManagedBean.correctCaptchaOption.color)}" />
					<h:outputText value=" " />
					<h:outputText
						value="#{captchaManagedBean.localizeNumber(captchaManagedBean.correctCaptchaOption.number)}" />
					<br />

					<h:panelGroup id="captcha">
						<ui:repeat value="#{captchaManagedBean.possibleCaptchaOptions}"
							var="captchaoption">
							<h:commandLink
								actionListener="#{captchaManagedBean.answer(captchaoption)}">
								<h:outputText value="#{captchaoption.number}"
									style="color:#{captchaoption.color}" />
								<f:ajax render="@form :newcommentform:postcommentbutton" />
							</h:commandLink>

						</ui:repeat>

					</h:panelGroup>
					<h:message for="captcha" id="logincaptchamessage"
						showSummary="true" showDetail="false" errorClass="errorstyle" />
					<br />





				</h:panelGroup>

			</h:form>










			<hr />
			<h2>Comments</h2>
			<h:form id="commentorderform">
				<h:commandButton value="#{yescommentmsg['newest first']}"
					styleClass="button first oneselectorbutton"
					actionListener="#{viewArticleManagedBean.setCommentSortOder('NEWESTFIRST')}"
					disabled="#{viewArticleManagedBean.getCommentSortOder()=='NEWESTFIRST'}">
					<f:ajax render=":comments @form" />
				</h:commandButton>
				<h:commandButton value="#{yescommentmsg['oldest first']}"
					styleClass="button middle oneselectorbutton"
					actionListener="#{viewArticleManagedBean.setCommentSortOder('OLDESTFIRST')}"
					disabled="#{viewArticleManagedBean.getCommentSortOder()=='OLDESTFIRST'}">
					<f:ajax render=":comments @form" />
				</h:commandButton>
			</h:form>
			<h:panelGroup id="comments">


				<h:form id="commentpaginatorform"
					rendered="#{!viewArticleManagedBean.article.comments.isEmpty()}">
					<h:commandLink value="First Page"
						actionListener="#{viewArticleManagedBean.firstPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Prev Page"
						actionListener="#{viewArticleManagedBean.prevPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Next Page"
						actionListener="#{viewArticleManagedBean.nextPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Last Page"
						actionListener="#{viewArticleManagedBean.lastPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
				</h:form>

				<ui:repeat value="#{viewArticleManagedBean.getCommentsOfArticle()}"
					var="comment" varStatus="varStatus">
					<h:panelGroup
						rendered="#{varStatus.index ge viewArticleManagedBean.commentStartIndex and varStatus.index le viewArticleManagedBean.commentEndIndex}">
						<h:panelGrid columns="7">
							<h:outputText value="#{comment.commentDate}">
								<f:convertDateTime type="both" dateStyle="short" />
							</h:outputText>



							<h:outputText value="#{comment.author}" />


							<h:outputText
								value="#{viewArticleManagedBean.getOrderNumberOfComment(comment)}" />
							<h:panelGroup>
								<h:form>
									<h:outputText value="#{comment.plusCount}" />
									<h:commandLink value="Vote up"
										disabled="#{viewArticleManagedBean.alreadyVotedOnComment(comment)}"
										actionListener="#{viewArticleManagedBean.upvoteComment(comment)}">
										<f:ajax render="@form" />
									</h:commandLink>

									<h:outputText value="#{comment.minusCount}" />
									<h:commandLink value="Vote down"
										disabled="#{viewArticleManagedBean.alreadyVotedOnComment(comment)}"
										actionListener="#{viewArticleManagedBean.downvoteComment(comment)}">
										<f:ajax render="@form" />
									</h:commandLink>
								</h:form>
							</h:panelGroup>
							<h:link value="Link to comment">
								<f:param name="articleId"
									value="#{viewArticleManagedBean.articleId}" />
								<f:param name="highlightCommentId" value="#{comment.id}" />
							</h:link>
							<h:outputText
								value="HIGHLIGHT:#{viewArticleManagedBean.commentShouldBeHighlighted(comment)}" />
						</h:panelGrid>
						<br />
						<h:outputText value="#{comment.commentText}"
							style="white-space:pre;" />
						<!-- pre is needed for whitespacing -->
						<hr />
					</h:panelGroup>


				</ui:repeat>
			</h:panelGroup>


		</h:panelGroup>

	</ui:define>

</ui:composition>