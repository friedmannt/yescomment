<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	template="/template.xhtml">

	<f:metadata>
		<f:viewParam name="articleId"
			value="#{viewArticleManagedBean.articleId}" />
		<f:viewParam name="highlightCommentId"
			value="#{viewArticleManagedBean.highlightCommentId}" />
		<f:viewAction action="#{viewArticleManagedBean.loadArticle()}" />
	</f:metadata>

	<ui:define name="content">
	
		<h:messages showSummary="true" />
		<h:panelGroup rendered="#{viewArticleManagedBean.article!=null}">
			<ui:include src="articlepreview.xhtml">
				<ui:param name="article" value="#{viewArticleManagedBean.article}" />
				
			</ui:include>
			<h:form id="articlelinkform">
					<h:outputLink value="#{viewArticleManagedBean.article.url}"
						>#{yescommentmsg['open_original_article']}</h:outputLink>

				</h:form>
			<hr />
			<h:form id="newcommentform">
				New Comment
				<h:inputTextarea value="#{viewArticleManagedBean.newCommentText}"
					pt:maxlength="#{viewArticleManagedBean.getMaxCommentSize()}"
					id="newCommentText" rows="5" cols="80" required="true"
					requiredMessage="Empty comment" />
				<h:message for="newCommentText" />
				<br />


				<h:outputText value="Author" />
				<h:outputText value="#{viewArticleManagedBean.newCommentAuthor}"
					id="newCommentAuthor" />
				<br />

				<h:commandButton value="Post"
					disabled="#{userSessionBean.loginUserName == null}"
					actionListener="#{viewArticleManagedBean.postNewComment()}">
					<f:ajax render=":comments :newcommentform" execute="@form" />
				</h:commandButton>
			</h:form>
			<h:form id="unauthenticatedform">
				<h:commandButton id="whoareyoubutton" value="Who are you?"
					action="#{viewArticleManagedBean.loginAction()}"
					rendered="#{userSessionBean.loginUserName == null}" />
			</h:form>
			<h2>Comments</h2>
			<h:form id="commentorderform">
				<p:selectBooleanButton
					value="#{viewArticleManagedBean.reverseArticleOrder}"
					onLabel="Newest first" offLabel="Oldest first">
					<p:ajax event="change" update=":comments" />
				</p:selectBooleanButton>
			</h:form>
			<h:panelGroup id="comments">


				<h:form id="commentpaginatorform"
					rendered="#{!viewArticleManagedBean.article.comments.isEmpty()}">
					<h:commandLink value="First Page"
						actionListener="#{viewArticleManagedBean.firstPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Prev Page"
						actionListener="#{viewArticleManagedBean.prevPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Next Page"
						actionListener="#{viewArticleManagedBean.nextPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
					<h:commandLink value="Last Page"
						actionListener="#{viewArticleManagedBean.lastPage()}">
						<f:ajax render=":comments" />
					</h:commandLink>
				</h:form>

				<ui:repeat value="#{viewArticleManagedBean.getCommentsOfArticle()}"
					var="comment" varStatus="varStatus">
					<h:panelGroup
						rendered="#{varStatus.index ge viewArticleManagedBean.commentStartIndex and varStatus.index le viewArticleManagedBean.commentEndIndex}">
						<h:panelGrid columns="7">
							<h:outputText value="#{comment.commentDate}" />


							<h:outputText value="#{comment.author}" />


							<h:outputText
								value="#{viewArticleManagedBean.getOrderNumberOfComment(comment)}" />
							<h:panelGroup>
								<h:form>
									<h:outputText value="#{comment.plusCount}" />
									<h:commandLink value="Vote up"
										disabled="#{viewArticleManagedBean.alreadyVotedOnComment(comment)}"
										actionListener="#{viewArticleManagedBean.upvoteComment(comment)}">
										<f:ajax render="@form" />
									</h:commandLink>

									<h:outputText value="#{comment.minusCount}" />
									<h:commandLink value="Vote down"
										disabled="#{viewArticleManagedBean.alreadyVotedOnComment(comment)}"
										actionListener="#{viewArticleManagedBean.downvoteComment(comment)}">
										<f:ajax render="@form" />
									</h:commandLink>
								</h:form>
							</h:panelGroup>
							<h:link value="Link to comment">
								<f:param name="articleId"
									value="#{viewArticleManagedBean.articleId}" />
								<f:param name="highlightCommentId" value="#{comment.id}" />
							</h:link>
							<h:outputText
								value="HIGHLIGHT:#{viewArticleManagedBean.commentShouldBeHighlighted(comment)}" />
						</h:panelGrid>
						<br />
						<h:outputText value="#{comment.commentText}"
							style="white-space:pre;" />
						<!-- pre is needed for whitespacing -->
						<hr />
					</h:panelGroup>


				</ui:repeat>
			</h:panelGroup>


		</h:panelGroup>
	</ui:define>
</ui:composition>